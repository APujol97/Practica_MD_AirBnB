---
title: "Minería de Datos, Práctica AirBNB, Cuestión 2"
author:
  - Alcázar Gajo, Crist 
  - Pujol Villegas, Antonio 
  - Mas Pons, Albert 
  - Muñoz Navarro, Francisco José 
  - Campaner Gutiérrez, Joan
date: "7 de enero, 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Apartado 1 ##

En este apartado anotaremos la frecuencia del número de reseñas por apartamento, reflejando cuántos apartamentos han tenido un número determinado de reviews. Tras ello veremos si esta frecuencia tiene junto el rango de distintas frecuencas dadas, una relación potencial o "power law".

```{r}
library(readr)
listing <- read_csv("data/listingsCiudadesLimpio.csv")


aux<-c()

for(i in 1:length(listing$number_of_reviews)){

   if(!is.na(listing$number_of_reviews[i])){
     aux<-c(aux,listing$number_of_reviews[i])
  }
 
}
tabla_frecuencias<- table(aux)
```

Tras recopilar las frecuencias, presentamos la gráfica.

```{r}
freqs_data<-as.data.frame(tabla_frecuencias)
str(freqs_data)
ggplot(data = freqs_data, aes(x = freqs_data$aux, y = freqs_data$Freq, group = 1))+geom_point()+labs(title = "frecuencias vs rango frecuencias")+xlab("rango frecuencias")+ylab("frecuencias")+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))
```


De la gráfica podemos observar y ,por tanto, confirmar que sí se sigue una relación potencial.

## Apartado 2##
# Reviews por zona, barrio, dias de la semana y meses#

Limpiar nombres y características que no se usan.

```{r}

library("data.table") 

reviewsMallorca <- read_csv("data/Mallorca/reviews.csv")
reviewsBarcelona <- read_csv("data/Barcelona/reviews.csv")
reviewsValencia<- read_csv("data/Valencia/reviews.csv")
reviewsMexico<- read_csv("data/Mexico/reviews.csv")
reviewsBuenosAires<- read_csv("data/Buenos_Aires/reviews.csv")
reviewsMallorca <- cbind(reviewsMallorca,Ciudad=c("Mallorca"))
reviewsBarcelona <- cbind(reviewsBarcelona,Ciudad=c("Barcelona"))
reviewsValencia <- cbind(reviewsValencia,Ciudad=c("Valencia"))
reviewsMexico <- cbind(reviewsMexico,Ciudad=c("Mexico"))
reviewsBuenosAires <- cbind(reviewsBuenosAires,Ciudad=c("Buenos Aires"))
#Unimos todos los dataframes en uno único
reviews <- rbind(reviewsMallorca, reviewsBarcelona, reviewsValencia, reviewsMexico, reviewsBuenosAires)
#Guardamos los nuevos datos
write_csv(x = reviews, "data/reviewsCiudades.csv")

listings <- read_csv("data/listingsCiudadesLimpio.csv")
setnames(listings, "X..email", "email")
setnames(listings, "government_id..", "government_id")
setnames(listings, "identity_manual..", "identity_manual")
setnames(listings, "reviews..", "reviews")
setnames(listings, "work_email..", "work_email")
setnames(listings, "email", "X..email..")
listings$X..phone <- NULL
listings$X..phone.. <- NULL
listings$phone.. <- NULL
listings$manual_offline.. <- NULL
listings$X..reviews.. <- NULL
listings$X..identity_manual.. <- NULL
listings$X..jumio <- NULL
listings$photographer.. <- NULL
listings$X..offline_government_id <- NULL

```


```{r}
library("data.table") 
library(magrittr)
library(dplyr)
library(forcats)

#para que salga en inglés
Sys.setlocale("LC_TIME","C")

#para ordenar los plots a la hora de mostrarlo
month_names <- c("January","February","March","April","May","June","July","August","September","October","November","December")
day_names <- c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")

#creamos el dataset reviews a partir de las tablas de reviews de las ciudades
reviews <- read_csv("data/reviewsCiudades.csv")


#añadimos las características necesarias
reviews$day <- weekdays(as.Date(reviews$date))
reviews$month <- month.name[month(as.Date(reviews$date))]
setnames(listings, "id", "listing_id")
reviews <- merge(reviews, listings[, c("listing_id", "neighbourhood_cleansed")], by="listing_id")
setnames(listings, "listing_id", "id")
setnames(reviews, "neighbourhood_cleansed", "zone")

#el dataset con todas las características necesarias
str(reviews)

#ahora montamos las tablas con la información que se pide
#count para zones y ciudades
reviews_zone <- aggregate(list(reviews=listings$number_of_reviews), by=list(zona=listings$neighbourhood_cleansed, ciudad=listings$Ciudad), FUN=sum) 
reviews_city <- aggregate(list(reviews=listings$number_of_reviews), by=list(ciudad=listings$Ciudad), FUN=sum) 

#order descent
reviews_zone <- reviews_zone[order(-reviews_zone$reviews),] 
reviews_city <- reviews_city[order(-reviews_city$reviews),] 

#count para dias y meses
reviews_day <- data.frame(table(reviews$day))
setnames(reviews_day, "Freq", "reviews")
setnames(reviews_day, "Var1", "day")
reviews_month <- data.frame(table(reviews$month))
setnames(reviews_month, "Freq", "reviews")
setnames(reviews_month, "Var1", "month")

#order descent
reviews_day <- reviews_day[order(-reviews_day$reviews),] 
reviews_month <- reviews_month[order(-reviews_month$reviews),] 


#algunos plots de muestra que podrían ser útiles


#plot ordenado
p <- reviews %>%
  mutate(day = fct_relevel(day,day_names)) %>%
  ggplot( aes(x=day, fill=Ciudad)) +
    geom_bar(position = "dodge")
p

#plot ordenado
p <- reviews %>%
  mutate(month = fct_relevel(month,month_names)) %>%
  ggplot( aes(x=month, fill=Ciudad)) +
    geom_bar(position = "dodge")
p


#se observan las ciudades con temporalidad/estacionalidad
ggplot(data = reviews, aes(x = date, y = Ciudad, group = 1)) +
    geom_count(alpha=0.01)+
    scale_size_area(max_size = 10)


#Las tablas de lo que se pide
reviews_day
reviews_month
reviews_zone
reviews_city
```

## Apartado 3 ##

En este apartado recopilaremos el precio medio de todo el periodo, el número medio de camas, y el número medio de habitaciones de todos los apartamentos pertenecientes a los 5 barrios, con más apartamentos, de las 5 ciudades propuestas.

```{r}

barriosMallorca<-c()
barriosValencia<-c()
barriosMexico<-c()
barriosBuenos<-c()
barriosBarcelona<-c()

for(i in 1:length(listing$Ciudad)){
  
   if(listing$Ciudad[i] == "Mallorca"){
     barriosMallorca<-c(barriosMallorca,listing$neighbourhood_cleansed[i])
   }
  if(listing$Ciudad[i] == "Barcelona"){
     barriosBarcelona<-c(barriosBarcelona,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Valencia"){
     barriosValencia<-c(barriosValencia,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Mexico"){
     barriosMexico<-c(barriosMexico,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Buenos Aires"){
     barriosBuenos<-c(barriosBuenos,listing$neighbourhood_cleansed[i])
  }
 
}

barriosMallorca<-table(barriosMallorca)
barriosValencia<-table(barriosValencia)
barriosMexico<-table(barriosMexico)
barriosBuenos<-table(barriosBuenos)
barriosBarcelona<-table(barriosBarcelona)

barriosMallorca<-barriosMallorca[order(unlist(barriosMallorca))]
barriosMallorcaFiltrados<-data.frame(tail(barriosMallorca, 5))

barriosValencia<-barriosValencia[order(unlist(barriosValencia))]
barriosValenciaFiltrados<-data.frame(tail(barriosValencia, 5))

barriosMexico<-barriosMexico[order(unlist(barriosMexico))]
barriosMexicoFiltrados<-data.frame(tail(barriosMexico, 5))

barriosBuenos<-barriosBuenos[order(unlist(barriosBuenos))]
barriosBuenosFiltrados<-data.frame(tail(barriosBuenos, 5))

barriosBarcelona<-barriosBarcelona[order(unlist(barriosBarcelona))]
barriosBarcelonaFiltrados<-data.frame(tail(barriosBarcelona, 5))

#Creamos un dataframe que contendra los 5 barrios son mas viviendas vacacionales de la 5 ciudades

barriosTotales=data.frame("Mallorca"=barriosMallorcaFiltrados$barriosMallorca)
barriosTotales=cbind(barriosTotales,"Valencia"=barriosValenciaFiltrados$barriosValencia)
barriosTotales=cbind(barriosTotales,"Mexico"=barriosMexicoFiltrados$barriosMexico)
barriosTotales=cbind(barriosTotales,"Buenos Aires"=barriosBuenosFiltrados$barriosBuenos)
barriosTotales=cbind(barriosTotales,"Barcelona"=barriosBarcelonaFiltrados$barriosBarcelona)

#Creamos el dataframe que contendra los valores finales medios 

datos <- data.frame(precioMedio=integer(),
                 habMedia=integer(), 
                 camasMedia=integer(), 
                 barrio=character(),
                 ciudad=character()) 
```

Tras obtener los cinco barrios con mas viviendas de las cinco ciudades pasamos a calcular la media del precio, de las habitaciones y de la camas por barrio. Una vez hechas lo guardaremos todo dentro de un data set llamado datos

```{r}

library("dplyr")

for(j in 1:length(barriosTotales)){
  
  for(i in 1:length(barriosTotales[,j])){
    
  aux2<-select( listing[listing$neighbourhood_cleansed == barriosTotales[i,j],], price , bedrooms , beds )
    
  aux2$price[is.na(aux2$price)]<-0
  aux2$bedrooms[is.na(aux2$bedrooms)]<-0
  aux2$beds[is.na(aux2$beds)]<-0
  
  #Hacemos la conversion de moneda a Euros empleando una ponderación aproximada a la actual
  if(colnames(barriosTotales[j])=="Mexico"){
    aux2$price<-aux2$price * 0.043
  }
  if(colnames(barriosTotales[j])=="Buenos Aires"){
    aux2$price<-aux2$price * 0.0086
  }
    
  precioMedio<-sum(aux2$price)/length(aux2$price)
  habMedio<-sum(aux2$bedrooms)/length(aux2$bedrooms)
  camasMedio<-sum(aux2$beds)/length(aux2$beds)
     
  nuevosDatos=data.frame( precioMedio=precioMedio, habMedia=habMedio, camasMedia=camasMedio, barrio=barriosTotales[i,j] , ciudad=colnames(barriosTotales[j]))
  datos=rbind(datos,nuevosDatos)
    
  }
 
}

print.data.frame(datos)

```

A partir de los datos recopilados en el DataFrame, podemos observar que:

1- Los precios más caros, para este caso, son para los apartamentos de Mallorca,Valencia y Barcelona, mientras que los más baratos serían los de Mexico y Buenos Aires. 

2- Los precios en cada ciudad, para cada barrio, varían más en Barcelona que en el resto.

3- Suele haber más habitaciones de media en los apartamentos de Mallorca que en los ofertados en las otras ciudades con considerable diferencia.

4- De nuevo, y posiblemente en relación con el punto anterior, los apaertamentos de Mallorca ofrecen más camas que los ofertados por otras ciudades con destacable diferencia, siendo el caso de Mexico donde menos camas, de media, se ofertan.

## Apartado 4 ##
# Para la serie temporal de los precios medios, máximos y mínimos por día, semana y mes se realizará el estudio desde noviembre de 2021 hasta octubre de 2022.

# Necesitamos los precios y las fechas, que estan en los archivos calendar.csv para obtener los datos

```{r}
priceMallorca <- read_csv("data/Mallorca/calendar.csv")
priceBarcelona <- read_csv("data/Barcelona/calendar.csv")
priceValencia<- read_csv("data/Valencia/calendar.csv")
priceMexico<- read_csv("data/Mexico/calendar.csv")
priceBuenosAires<- read_csv("data/Buenos_Aires/calendar.csv")

priceColumns <- c("date","price")


cpriceMallorca <- priceMallorca[priceColumns]
cpriceBarcelona <- priceBarcelona[priceColumns]
cpriceValencia <- priceValencia[priceColumns]
cpriceMexico <- priceMexico[priceColumns]
cpriceBuenosAires <- priceBuenosAires[priceColumns]

# Si queremos comparar las ciudades tendríamos que coger los datos de forma coherente, empezando por una misma fecha, pore ejemplo a partir del 1 de noviembre de 2021 para tener todos los datos en el mismo inicio. Podría hacerse como sigue:

#cpriceMallorca <- select(cpriceMallorca[cpriceMallorca$date >= "2021-11-01",], date, price)
#cpriceBarcelona <- select(cpriceBarcelona[cpriceBarcelona$date >= "2021-11-01",], date, price)
#cpriceValencia <- select(cpriceValencia[cpriceValencia$date >= "2021-11-01",], date, price)
#cpriceMexico <- select(cpriceMexico[cpriceMexico$date >= "2021-11-01",], date, price)
#cpriceBuenosAires <- select(cpriceBuenosAires[cpriceBuenosAires$date >= "2021-11-01",], date, price)

# Añadimos la columna para la ciudad
dfpriceMallorca <- cbind(cpriceMallorca,Ciudad=c("Mallorca"))
dfpriceBarcelona <- cbind(cpriceBarcelona,Ciudad=c("Barcelona"))
dfpriceValencia <- cbind(cpriceValencia,Ciudad=c("Valencia"))
dfpriceMexico <- cbind(cpriceMexico,Ciudad=c("Mexico"))
dfpriceBuenosAires <- cbind(cpriceBuenosAires,Ciudad=c("Buenos Aires"))

dfpriceMallorca$Ciudad<-as.factor(dfpriceMallorca$Ciudad)
dfpriceBarcelona$Ciudad<-as.factor(dfpriceBarcelona$Ciudad)
dfpriceValencia$Ciudad<-as.factor(dfpriceValencia$Ciudad)
dfpriceMexico$Ciudad<-as.factor(dfpriceMexico$Ciudad)
dfpriceBuenosAires$Ciudad<-as.factor(dfpriceBuenosAires$Ciudad)

#Unimos todos los dataframes en uno único
prices <- rbind(dfpriceMallorca, dfpriceBarcelona, dfpriceValencia, dfpriceMexico, dfpriceBuenosAires)

# y limpiamos los datos

prices$price = gsub("\\,", "", prices$price)

prices$price = as.numeric(gsub("\\$", "", prices$price))
prices$date <- as.Date(prices$date)
prices<-na.omit(prices)
# colSums(is.na(prices))

```

```{r}




# dfpriceMallorca$price = gsub("\\,", "", dfpriceMallorca$price)
# 
# dfpriceMallorca$price = as.numeric(gsub("\\$", "", dfpriceMallorca$price))
# dfpriceMallorca$date <- as.Date(dfpriceMallorca$date)
# dfpriceMallorca<-na.omit(dfpriceMallorca)
# colSums(is.na(dfpriceMallorca))
# Para mirar en que fechas empiezan y acaban los datos para cada ciudad:

mMallorca<-min(select(prices[prices$Ciudad == "Mallorca",],date)$date, na.rm = TRUE)
mBarcelona<-min(select(prices[prices$Ciudad == "Barcelona",],date)$date, na.rm = TRUE)
mValencia<-min(select(prices[prices$Ciudad == "Valencia",],date)$date, na.rm = TRUE)
mMexico<-min(select(prices[prices$Ciudad == "Mexico",],date)$date, na.rm = TRUE)
mBuenosAires<-min(select(prices[prices$Ciudad == "Buenos Aires",],date)$date, na.rm = TRUE)

MMallorca<-max(select(prices[prices$Ciudad == "Mallorca",],date)$date, na.rm = TRUE)
MBarcelona<-max(select(prices[prices$Ciudad == "Barcelona",],date)$date, na.rm = TRUE)
MValencia<-max(select(prices[prices$Ciudad == "Valencia",],date)$date, na.rm = TRUE)
MMexico<-max(select(prices[prices$Ciudad == "Mexico",],date)$date, na.rm = TRUE)
MBuenosAires<-max(select(prices[prices$Ciudad == "Buenos Aires",],date)$date, na.rm = TRUE)

# Número total de días para los que se tienen datos
MMallorca-mMallorca
MBarcelona-mBarcelona
MValencia-mValencia
MMexico-mMexico
MBuenosAires-mBuenosAires
```
# Serie temporal para cada ciudad:

# Hemos detectado precios gratuitos y valores muy altos que desvirtuan las medias y los valores mínimos y máximos,
# podríamos utilizar un filtro para no considerarlos, si se quieren filtar o mostrar todos los datos basta con
# comentar o descomentar la primera línea.

# Mallorca
```{r}



# prices <- filter(prices, (((Ciudad=="Valencia" | Ciudad=="Mallorca" | Ciudad=="Barcelona") & price<11000) | Ciudad=="Mexico" | Ciudad=="Buenos Aires")  & price>0)

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio diario

# Media, mínimo y máximo de Mallorca

valoresMallorca <- select(prices[prices$Ciudad == "Mallorca",],date,price,Ciudad) %>% group_by(date)

diaMallorca  <-  valoresMallorca %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

diaMallorca

# Time series de Mallorca
tsMallorca.ts <- ts(select(diaMallorca,media,maxim,minim))
plot(tsMallorca.ts[, 'media'], main = "Media precio diario Mallorca", ylab = "Precio diario")
plot(tsMallorca.ts[, 'minim'], main = "Media precio mínimo Mallorca", ylab = "Precio diario")
plot(tsMallorca.ts[, 'maxim'], main = "Media precio máximo Mallorca", ylab = "Precio diario")

# Se obtienen resultados extraños, mínimo de zero y máximo muy grande, con un summary, verificamos que efectivamente, hay valores nulos y muy grandes en los datos iniciales

# > mediaDiaMallorca
# # A tibble: 366 × 4
#    date       media maxim minim
#    <date>     <dbl> <dbl> <dbl>
#  1 2021-10-14  217. 21000     0
#  2 2021-10-15  224. 21000     0
#  3 2021-10-16  223. 21000     0
#  4 2021-10-17  222. 21000     0
#  5 2021-10-18  221. 21000     0
#  6 2021-10-19  221. 21000     0
#  7 2021-10-20  221. 21000     0
#  8 2021-10-21  221. 21000     0
#  9 2021-10-22  222. 21000     0
# 10 2021-10-23  222. 21000     0
# # … with 356 more rows

#summary(prices)
      #      date                price           Ciudad         
      # Min.   :2021-10-11   Min.   :     0   Length:28067022   
      # 1st Qu.:2022-01-19   1st Qu.:   106   Class :character  
      # Median :2022-04-20   Median :   350   Mode  :character  
      # Mean   :2022-04-20   Mean   :  1956                     
      # 3rd Qu.:2022-07-20   3rd Qu.:  1592                     
      # Max.   :2022-10-30   Max.   :997739
  
# y la conversión de los datos es correcta, ya que el valor 49999 en prices, por ejemplo

      # > prices[1932716,]
      #               date price   Ciudad
      # 1932716 2022-01-09 49999 Mallorca

# es la conversión de

      #> cpriceMallorca[1932716,]
      # # A tibble: 1 × 2
      #   date       price     
      #   <date>     <chr>     
      # 1 2022-01-09 $49,999.00

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio mensual

# Precio mensual Mallorca
mesMallorca <- valoresMallorca %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
           
mesMallorca

# Time series de Mallorca
tsMallorca.ts.m <- ts(select(mesMallorca,media,maxim,minim))
plot(tsMallorca.ts.m[, 'media'], main = "Media precio mes Mallorca", ylab = "Precio mensual")
plot(tsMallorca.ts.m[, 'minim'], main = "Media precio mínimo Mallorca", ylab = "Precio mensual")
plot(tsMallorca.ts.m[, 'maxim'], main = "Media precio máximo Mallorca", ylab = "Precio mensual")

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio Anual

añoMallorca <- valoresMallorca %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoMallorca

# Time series de Mallorca
tsMallorca.ts.a <- ts(select(añoMallorca,media,maxim,minim), start="2021", end="2022")
plot(tsMallorca.ts.a[, 'media'], main = "Media precio año Mallorca", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsMallorca.ts.a[, 'minim'], main = "Media precio mínimo Mallorca", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsMallorca.ts.a[, 'maxim'], main = "Media precio máximo Mallorca", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
  
```

Barcelona

```{r}
# Media, mínimo y máximo de Barcelona

valoresBarcelona <- select(prices[prices$Ciudad == "Barcelona",],date,price,Ciudad) %>% group_by(date)
diaBarcelona  <-  valoresBarcelona %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

diaBarcelona

# Time series de Barcelona
tsBarcelona.ts <- ts(select(diaBarcelona,media,maxim,minim))
plot(tsBarcelona.ts[, 'media'], main = "Media precio diario Barcelona", ylab = "Precio diario")
plot(tsBarcelona.ts[, 'minim'], main = "Media precio mínimo Barcelona", ylab = "Precio diario")
plot(tsBarcelona.ts[, 'maxim'], main = "Media precio máximo Barcelona", ylab = "Precio diario")

# Precio mensual Barcelona
mesBarcelona <- valoresBarcelona %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )

mesBarcelona

# Time series de Barcelona
tsBarcelona.ts.m <- ts(select(mesBarcelona,media,maxim,minim))
plot(tsBarcelona.ts.m[, 'media'], main = "Media precio mes Barcelona", ylab = "Precio mensual")
plot(tsBarcelona.ts.m[, 'minim'], main = "Media precio mínimo Barcelona", ylab = "Precio mensual")
plot(tsBarcelona.ts.m[, 'maxim'], main = "Media precio máximo Barcelona", ylab = "Precio mensual")

# Precio anual Barcelona
añoBarcelona <- valoresBarcelona %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoBarcelona

# Time series de Barcelona
tsBarcelona.ts.a <- ts(select(añoBarcelona,media,maxim,minim), start="2021", end="2022")
plot(tsBarcelona.ts.a[, 'media'], main = "Media precio año Barcelona", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsBarcelona.ts.a[, 'minim'], main = "Media precio mínimo Barcelona", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsBarcelona.ts.a[, 'maxim'], main = "Media precio máximo Barcelona", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))

```

Valencia

```{r}
# Media, mínimo y máximo de Valencia

valoresValencia <- select(prices[prices$Ciudad == "Valencia",],date,price,Ciudad) %>% group_by(date)

diaValencia  <-  valoresValencia %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

diaValencia

# Time series de Valencia
tsValencia.ts <- ts(select(diaValencia,media,maxim,minim))
plot(tsValencia.ts[, 'media'], main = "Media precio diario Valencia", ylab = "Precio diario")
plot(tsValencia.ts[, 'minim'], main = "Media precio mínimo Valencia", ylab = "Precio diario")
plot(tsValencia.ts[, 'maxim'], main = "Media precio máximo Valencia", ylab = "Precio diario")

# Precio mensual Valencia
mesValencia <- valoresValencia %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesValencia

# Time series de Valencia
tsValencia.ts.m <- ts(select(mesValencia,media,maxim,minim))
plot(tsValencia.ts.m[, 'media'], main = "Media precio mes Valencia", ylab = "Precio mensual")
plot(tsValencia.ts.m[, 'minim'], main = "Media precio mínimo Valencia", ylab = "Precio mensual")
plot(tsValencia.ts.m[, 'maxim'], main = "Media precio máximo Valencia", ylab = "Precio mensual")

# Precio anual Valencia
añoValencia <- valoresValencia %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoValencia

# Time series de Valencia
tsValencia.ts.a <- ts(select(añoValencia,media,maxim,minim), start="2021", end="2022")
plot(tsValencia.ts.a[, 'media'], main = "Media precio año Valencia", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsValencia.ts.a[, 'minim'], main = "Media precio mínimo Valencia", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsValencia.ts.a[, 'maxim'], main = "Media precio máximo Valencia", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))

```

Mexico

```{r}
# Media, mínimo y máximo de Mexico

valoresMexico <- select(prices[prices$Ciudad == "Mexico",],date,price,Ciudad) %>% group_by(date)

diaMexico  <-  valoresMexico %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

# Time series de Mexico
tsMexico.ts <- ts(select(diaMexico,media,maxim,minim))
plot(tsMexico.ts[, 'media'], main = "Media precio diario México", ylab = "Precio diario")
plot(tsMexico.ts[, 'minim'], main = "Media precio mínimo México", ylab = "Precio diario")
plot(tsMexico.ts[, 'maxim'], main = "Media precio máximo México", ylab = "Precio diario")

# Precio mensual Mexico
mesMexico <- valoresMexico %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesMexico

# Time series de Mexico
tsMexico.ts.m <- ts(select(mesMexico,media,maxim,minim))
plot(tsMexico.ts.m[, 'media'], main = "Media precio mes Mexico", ylab = "Precio mensual")
plot(tsMexico.ts.m[, 'minim'], main = "Media precio mínimo Mexico", ylab = "Precio mensual")
plot(tsMexico.ts.m[, 'maxim'], main = "Media precio máximo Mexico", ylab = "Precio mensual")

# Precio anual Mexico
añoMexico    <- valoresMexico %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoMexico

# Time series de Mexico
tsMexico.ts.a <- ts(select(añoMexico,media,maxim,minim), start="2021", end="2022")
plot(tsMexico.ts.a[, 'media'], main = "Media precio año Mexico", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsMexico.ts.a[, 'minim'], main = "Media precio mínimo Mexico", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsMexico.ts.a[, 'maxim'], main = "Media precio máximo Mexico", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))

```

Buenos Aires

```{r}
# Media, mínimo y máximo de Buenos Aires

valoresBuenosAires <- select(prices[prices$Ciudad == "Buenos Aires",],date,price,Ciudad) %>% group_by(date)

diaBuenosAires  <-  valoresBuenosAires %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )
  
diaBuenosAires

# Time series de Buenos Aires
tsBuenosAires.ts <- ts(select(diaBuenosAires,media,maxim,minim))
plot(tsBuenosAires.ts[, 'media'], main="Media precio diario Buenos Aires", ylab ="Precio diario")
plot(tsBuenosAires.ts[, 'minim'], main="Media precio mínimo Buenos Aires", ylab ="Precio diario")
plot(tsBuenosAires.ts[, 'maxim'], main="Media precio máximo Buenos Aires", ylab ="Precio diario")

# Precio mensual Buenos Aires
mesBuenosAires <- valoresBuenosAires %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesBuenosAires

# Time series de Buenos Aires
tsBuenosAires.ts.m <- ts(select(mesBuenosAires,media,maxim,minim))
plot(tsBuenosAires.ts.m[, 'media'], main="Media precio mes Buenos Aires", ylab="Precio mensual")
plot(tsBuenosAires.ts.m[, 'minim'], main="Media precio mínimo Buenos Aires", ylab="Precio mensual")
plot(tsBuenosAires.ts.m[, 'maxim'], main="Media precio máximo Buenos Aires", ylab="Precio mensual")

# Precio anual Buenos Aires
añoBuenosAires <- valoresBuenosAires %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))

añoBuenosAires

# Time series de Buenos Aires
tsBuenosAires.ts.a <- ts(select(añoBuenosAires,media,maxim,minim), start="2021", end="2022")
plot(tsBuenosAires.ts.a[, 'media'], main = "Media precio año Buenos Aires", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsBuenosAires.ts.a[, 'minim'], main = "Media precio mínimo Buenos Aires", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))
plot(tsBuenosAires.ts.a[, 'maxim'], main = "Media precio máximo Buenos Aires", ylab = "Precio anual",xaxt = "n")
axis(1,at = c(2021, 2022),labels = c("2021", "2022"))

```

```{r}

# Para probar de forma rápida, cogemos los n primeros valors. Comentar esta línea para utilizarlos todos
#prices <- prices[1:10000,]

# y limpiamos los datos

prices$price = gsub("\\,", "", prices$price)

prices$price = as.numeric(gsub("\\$", "", prices$price))
prices$date <- as.Date(prices$date)
prices<-na.omit(prices)
# colSums(is.na(prices))


dfpriceMallorca$price = gsub("\\,", "", dfpriceMallorca$price)

dfpriceMallorca$price = as.numeric(gsub("\\$", "", dfpriceMallorca$price))
dfpriceMallorca$date <- as.Date(dfpriceMallorca$date)
dfpriceMallorca<-na.omit(dfpriceMallorca)
colSums(is.na(dfpriceMallorca))
# Para mirar en que fechas empiezan y acaban los datos para cada ciudad:

mMallorca<-min(select(prices[prices$Ciudad == "Mallorca",],date)$date, na.rm = TRUE)
mBarcelona<-min(select(prices[prices$Ciudad == "Barcelona",],date)$date, na.rm = TRUE)
mValencia<-min(select(prices[prices$Ciudad == "Valencia",],date)$date, na.rm = TRUE)
mMexico<-min(select(prices[prices$Ciudad == "Mexico",],date)$date, na.rm = TRUE)
mBuenosAires<-min(select(prices[prices$Ciudad == "Buenos Aires",],date)$date, na.rm = TRUE)

MMallorca<-max(select(prices[prices$Ciudad == "Mallorca",],date)$date, na.rm = TRUE)
MBarcelona<-max(select(prices[prices$Ciudad == "Barcelona",],date)$date, na.rm = TRUE)
MValencia<-max(select(prices[prices$Ciudad == "Valencia",],date)$date, na.rm = TRUE)
MMexico<-max(select(prices[prices$Ciudad == "Mexico",],date)$date, na.rm = TRUE)
MBuenosAires<-max(select(prices[prices$Ciudad == "Buenos Aires",],date)$date, na.rm = TRUE)

# Número total de días para los que se tienen datos
MMallorca-mMallorca
MBarcelona-mBarcelona
MValencia-mValencia
MMexico-mMexico
MBuenosAires-mBuenosAires

# Serie temporal para cada ciudad:
# stMallorca <- select(prices[prices$Ciudad == "Mallorca",],price)
# stBarcelona <- select(prices[prices$Ciudad == "Barcelona",],price)
# stValencia <- select(prices[prices$Ciudad == "Valencia",],price)
# stMexico <- select(prices[prices$Ciudad == "Mexico",],price)
# stBuenosAires <- select(prices[prices$Ciudad == "BuenosAires",],price)
# newdata<-cpriceBuenosAires[order(cpriceBuenosAires$date),]

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio diario

# Media, mínimo y máximo
valoresMallorca <- select(prices[prices$Ciudad == "Mallorca",],date,price,Ciudad) %>% group_by(date)

diaMallorca  <-  valoresMallorca %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

dmediaM <- ts(c(diaMallorca$media))
dmediaM
plot.ts(dmediaM)

dminimM <- ts(c(diaMallorca$minim))
dminimM
plot.ts(dminimM)

dmaximM <- ts(c(diaMallorca$maxim))
dmaximM
plot.ts(dmaximM)
# Se obtienen resultados extraños, mínimo de zero y máximo de 21000, con un summary, verificamos que efectivamente, hay valores nulos y muy grandes en los datos iniciales

# > mediaDiaMallorca
# # A tibble: 366 × 4
#    date       media maxim minim
#    <date>     <dbl> <dbl> <dbl>
#  1 2021-10-14  217. 21000     0
#  2 2021-10-15  224. 21000     0
#  3 2021-10-16  223. 21000     0
#  4 2021-10-17  222. 21000     0
#  5 2021-10-18  221. 21000     0
#  6 2021-10-19  221. 21000     0
#  7 2021-10-20  221. 21000     0
#  8 2021-10-21  221. 21000     0
#  9 2021-10-22  222. 21000     0
# 10 2021-10-23  222. 21000     0
# # … with 356 more rows

summary(prices)
      #      date                price           Ciudad         
      # Min.   :2021-10-11   Min.   :     0   Length:28067022   
      # 1st Qu.:2022-01-19   1st Qu.:   106   Class :character  
      # Median :2022-04-20   Median :   350   Mode  :character  
      # Mean   :2022-04-20   Mean   :  1956                     
      # 3rd Qu.:2022-07-20   3rd Qu.:  1592                     
      # Max.   :2022-10-30   Max.   :997739
  
# y la conversión de los datos es correcta, ya que el valor 49999 en prices, por ejemplo

      # > prices[1932716,]
      #               date price   Ciudad
      # 1932716 2022-01-09 49999 Mallorca

# es la conversión de

      #> cpriceMallorca[1932716,]
      # # A tibble: 1 × 2
      #   date       price     
      #   <date>     <chr>     
      # 1 2022-01-09 $49,999.00
  

valoresBarcelona <- select(prices[prices$Ciudad == "Barcelona",],date,price,Ciudad) %>% group_by(date)

diaBarcelona  <-  valoresBarcelona %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

diaBarcelona

valoresValencia <- select(prices[prices$Ciudad == "Valencia",],date,price,Ciudad) %>% group_by(date)

diaValencia  <-  valoresValencia %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )

diaValencia

valoresMexico <- select(prices[prices$Ciudad == "Mexico",],date,price,Ciudad) %>% group_by(date)

diaMexico  <-  valoresMexico %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )


diaBuenosAires

valoresBuenosAires <- select(prices[prices$Ciudad == "Buenos Aires",],date,price,Ciudad) %>% group_by(date)

diaBuenosAires  <-  valoresBuenosAires %>% group_by(date) %>% summarise(
    media = mean(price),
    maxim = max(price),
    minim = min(price)
  )
  

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio mensual


mesMallorca <- valoresMallorca %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
           
mesMallorca

mM <- ts(c(mesMallorca$media))
mM
plot.ts(mM)

mesBarcelona <- valoresBarcelona %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )

mesBarcelona

mesValencia <- valoresValencia %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesValencia

mesMexico <- valoresMexico %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesMexico

mesBuenosAires <- valoresBuenosAires %>% mutate(month = format(date, "%m"), year = format(date, "%Y")) %>%
                    group_by(month, year) %>%
                    summarise(
                      media = mean(price),
                      maxim = max(price),
                      minim = min(price)
                    )
mesBuenosAires

# Agrupamos por dia los precios de cada ciudad y hacemos la media, mínimo i maximo del precio Anual

añoMallorca <- valoresMallorca %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoMallorca

aM <- ts(añoMallorca$media, start = c(2021), end = c(2022))
aM
plot.ts(aM)

añoBarcelona <- valoresBarcelona %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoBarcelona

añoValencia <- valoresValencia %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoValencia

añoMexico    <- valoresMexico %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))
añoMexico

añoBuenosAires <- valoresBuenosAires %>% mutate(year = format(date, "%Y")) %>%
                  group_by(year) %>%
                  summarise(media = mean(price),
                            maxim = max(price),
                            minim = min(price))


```
