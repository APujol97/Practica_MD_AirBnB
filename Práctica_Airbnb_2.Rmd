---
title: "Minería de Datos, Práctica AirBNB, Cuestión 2"
author:
  - Alcázar Gajo, Crist 
  - Pujol Villegas, Antonio 
  - Mas Pons, Albert 
  - Muñoz Navarro, Francisco José 
  - Campaner Gutiérrez, Joan
date: "7 de enero, 2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Apartado 1 ##

En este apartado anotaremos la frecuencia del número de reseñas por apartamento, reflejando cuántos apartamentos han tenido un número determinado de reviews. Tras ello veremos si esta frecuencia tiene junto el rango de distintas frecuencas dadas, una relación potencial o "power law".

```{r}
library(readr)
listing <- read_csv("data/listingsCiudadesLimpio.csv")


aux<-c()

for(i in 1:length(listing$number_of_reviews)){

   if(!is.na(listing$number_of_reviews[i])){
     aux<-c(aux,listing$number_of_reviews[i])
  }
 
}
tabla_frecuencias<- table(aux)
```

Tras recopilar las frecuencias, presentamos la gráfica.

```{r}
library(ggplot2)
plot(tabla_frecuencias, main = "frecuencias vs rango frecuencias", xlab ="rango recuencias", ylab = "frecuencias")
```

De la gráfica podemos observar y ,por tanto, confirmar que sí se sigue una relación potencial.

## Apartado 3 ##

En este apartado recopilaremos el precio medio de todo el periodo, el número medio de camas, y el número medio de habitaciones de todos los apartamentos pertenecientes a los 5 barrios, con más apartamentos, de las 5 ciudades propuestas.

```{r}

barriosMallorca<-c()
barriosValencia<-c()
barriosMexico<-c()
barriosBuenos<-c()
barriosBarcelona<-c()

for(i in 1:length(listing$Ciudad)){
  
   if(listing$Ciudad[i] == "Mallorca"){
     barriosMallorca<-c(barriosMallorca,listing$neighbourhood_cleansed[i])
   }
  if(listing$Ciudad[i] == "Barcelona"){
     barriosBarcelona<-c(barriosBarcelona,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Valencia"){
     barriosValencia<-c(barriosValencia,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Mexico"){
     barriosMexico<-c(barriosMexico,listing$neighbourhood_cleansed[i])
  }
  if(listing$Ciudad[i] == "Buenos Aires"){
     barriosBuenos<-c(barriosBuenos,listing$neighbourhood_cleansed[i])
  }
 
}

barriosMallorca<-table(barriosMallorca)
barriosValencia<-table(barriosValencia)
barriosMexico<-table(barriosMexico)
barriosBuenos<-table(barriosBuenos)
barriosBarcelona<-table(barriosBarcelona)

barriosMallorca<-barriosMallorca[order(unlist(barriosMallorca))]
barriosMallorcaFiltrados<-data.frame(tail(barriosMallorca, 5))

barriosValencia<-barriosValencia[order(unlist(barriosValencia))]
barriosValenciaFiltrados<-data.frame(tail(barriosValencia, 5))

barriosMexico<-barriosMexico[order(unlist(barriosMexico))]
barriosMexicoFiltrados<-data.frame(tail(barriosMexico, 5))

barriosBuenos<-barriosBuenos[order(unlist(barriosBuenos))]
barriosBuenosFiltrados<-data.frame(tail(barriosBuenos, 5))

barriosBarcelona<-barriosBarcelona[order(unlist(barriosBarcelona))]
barriosBarcelonaFiltrados<-data.frame(tail(barriosBarcelona, 5))

barriosTotales=data.frame("Mallorca"=barriosMallorcaFiltrados$barriosMallorca)

barriosTotales=cbind(barriosTotales,"Valencia"=barriosValenciaFiltrados$barriosValencia)
barriosTotales=cbind(barriosTotales,"Mexico"=barriosMexicoFiltrados$barriosMexico)
barriosTotales=cbind(barriosTotales,"Buenos Aires"=barriosBuenosFiltrados$barriosBuenos)

barriosTotales=cbind(barriosTotales,"Barcelona"=barriosBarcelonaFiltrados$barriosBarcelona)

datos <- data.frame(precioMedio=integer(),
                 habMedia=integer(), 
                 camasMedia=integer(), 
                 barrio=character(),
                 ciudad=character()) 


aux2<-select(listing[listing$neighbourhood_cleansed == "Manacor",],price,bedrooms,beds)


for(j in 1:length(barriosTotales)){
  
  for(i in 1:length(barriosTotales[,j])){
    
    aux2<-select( listing[listing$neighbourhood_cleansed == barriosTotales[i,j],], price , bedrooms , beds )
    
  aux2$price[is.na(aux2$price)]<-0
  aux2$bedrooms[is.na(aux2$bedrooms)]<-0
  aux2$beds[is.na(aux2$beds)]<-0
    
  precioMedio<-sum(aux2$price)/length(aux2$price)
  habMedio<-sum(aux2$bedrooms)/length(aux2$bedrooms)
  camasMedio<-sum(aux2$beds)/length(aux2$beds)
     
  nuevosDatos=data.frame( precioMedio=precioMedio, habMedia=habMedio, camasMedia=camasMedio, barrio=barriosTotales[i,j] , ciudad=colnames(barriosTotales[j]))
  datos=rbind(datos,nuevosDatos)
    
  }
 
}
```

```{r}

print.data.frame(datos)

```
A partir de los datos recopilados en el DataFrame, podemos observar que:

1- Los precios más caros, para este caso, son para los apartamentos de Buenos Aires, mientras que los más baratos serían los de Valencia. 

2- Los precios en cada ciudad, para cada barrio, varía más en Buenos Aires y Mexico, y menos en el resto.

3- Suele haber más habitaciones de media en los apartamentos de Mallorca que en los ofertados en las otras ciudades con considerable diferencia.

4- De nuevo, y posiblemente en relación con el punto anterior, los apaertamentos de Mallorca ofrecen más camas que los ofertados por otras ciudades con destacable diferencia, siendo el caso de Mexico donde menos camas, de media, se ofertan.

## 2 Reviews por zona, barrio, dias de la semana y meses.


Limpiar nombres y características que no se usan.

```{r}

#install.packages("data.table")   
library("data.table") 

listings <- read_csv("data/listingsCiudadesLimpio.csv")
setnames(listings, "X..email", "email")
setnames(listings, "government_id..", "government_id")
setnames(listings, "identity_manual..", "identity_manual")
setnames(listings, "reviews..", "reviews")
setnames(listings, "work_email..", "work_email")
setnames(listings, "email", "X..email..")
listings$X..phone <- NULL
listings$X..phone.. <- NULL
listings$phone.. <- NULL
listings$manual_offline.. <- NULL
listings$X..reviews.. <- NULL
listings$X..identity_manual.. <- NULL
listings$X..jumio <- NULL
listings$photographer.. <- NULL
listings$X..offline_government_id <- NULL

summary(listings)

```


```{r}
library("data.table") 
#para que salga en inglés
Sys.setlocale("LC_TIME","C")

#para ordenar los plots a la hora de mostrarlo
month_names <- c("January","February","March","April","May","June","July","August","September","October","November","December")
day_names <- c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")

#creamos el dataset reviews a partir de las tablas de reviews de las ciudades
reviews <- read_csv("data/reviewsCiudades.csv")

#añadimos las características necesarias
reviews$day <- weekdays(as.Date(reviews$date))
reviews$month <- month.name[month(as.Date(reviews$date))]
setnames(listings, "id", "listing_id")
reviews <- merge(reviews, listings[, c("listing_id", "neighbourhood_cleansed")], by="listing_id")
setnames(listings, "listing_id", "id")
setnames(reviews, "neighbourhood_cleansed", "zone")

#el dataset con todas las características necesarias
reviews

#ahora montamos las tablas con la información que se pide
#count para zones y ciudades
reviews_zone <- aggregate(list(reviews=listings$number_of_reviews), by=list(zona=listings$neighbourhood_cleansed, ciudad=listings$Ciudad), FUN=sum) 
reviews_city <- aggregate(list(reviews=listings$number_of_reviews), by=list(ciudad=listings$Ciudad), FUN=sum) 

#order descent
reviews_zone <- reviews_zone[order(-reviews_zone$reviews),] 
reviews_city <- reviews_city[order(-reviews_city$reviews),] 

#count para dias y meses
reviews_day <- data.frame(table(reviews$day))
setnames(reviews_day, "Freq", "reviews")
setnames(reviews_day, "Var1", "day")
reviews_month <- data.frame(table(reviews$month))
setnames(reviews_month, "Freq", "reviews")
setnames(reviews_month, "Var1", "month")

#order descent
reviews_day <- reviews_day[order(-reviews_day$reviews),] 
reviews_month <- reviews_month[order(-reviews_month$reviews),] 



#algunos plots de muestra que podrían ser útiles

#plot ordenado
p <- reviews %>%
  mutate(day = fct_relevel(day,day_names)) %>%
  ggplot( aes(x=day, fill=Ciudad)) +
    geom_bar(position = "dodge")
p

#plot ordenado
p <- reviews %>%
  mutate(month = fct_relevel(month,month_names)) %>%
  ggplot( aes(x=month, fill=Ciudad)) +
    geom_bar(position = "dodge")
p


#se observan las ciudades con temporalidad/estacionalidad
ggplot(data = reviews, aes(x = date, y = Ciudad, group = 1)) +
    geom_count(alpha=0.01)+
    scale_size_area(max_size = 10)


#Las tablas de lo que se pide
reviews_day
reviews_month
reviews_zone
reviews_city
```
